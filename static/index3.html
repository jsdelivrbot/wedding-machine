<html>
	<head>
	<title>Wedding Machine</title>
	<style>
	html, body { margin: 0; padding: 0; 
	background-color: #000;
	}
	#slotmachine {
		width: 640px; height: 480px;
		position: absolute;
		left: 50%;
		margin-left: -320px;
	}
	h1 { color: #fff; text-align: center; }
	
	</style>
</head>
<body>
<h1 id="main-message"></h1>
<audio id="idle-music" src="/idle-music.ogg" loop autoplay></audio>
<script src="/three.js"></script>
<script src="/tween.js"></script>
<script src="/jquery.js"></script>
<script src="/eventable.js"></script>
<script src="/rsvp.js"></script>
<script src="/machine.js"></script>
<script>

var Music = {
		audio: $('#idle-music')[0],
		adjustVolume: function(volume) {
			return new RSVP.Promise(function(resolve, reject) {
				var alfa = {volume: Music.audio.volume},
					omega = {volume: volume},
					tween = new TWEEN.Tween(alfa).to(omega, 750)
								.onUpdate(function() {
									Music.audio.volume = this.volume;
								})
								.onComplete(resolve)
								.start();
			});
		},
		mute: function() {
			return Music.adjustVolume(0);
		},
		unmute: function() {
			return Music.adjustVolume(1);
		}
	},
	MESSAGES = {
		'idle-state': "Premi il pulsante per iniziare a giocare!",
		'start-gaming': "Tira la leva per giocare!",
		'winning': "Hai vinto, tira ancora la leva per rilanciare!",
		'losing': "Hai perso, ritira i tuoi confetti!"
	}

$(function() {
	var music = $('#idle-music')[0],
		message = $('#main-message'),
		START_PLAY = 83,  // Tasto S
		ROLL = 65;  // Tasto A  
	
	RSVP.on('error', function(reason) {
		console.assert(false, reason);
	});
	
	Machine.on('startDemo', function() {
		message.html(MESSAGES['idle-state']);
	});
	Machine.on('startGame', function() {
		message.html(MESSAGES['start-gaming']);
	});
	Machine.on('playerWin', function() {
		message.html(MESSAGES['winning']);
	});
	Machine.on('playerLoose', function() {
		message.html(MESSAGES['loosing']);
	});
	// init it all
	Machine.startDemo();
	$.post('/open-tray');

	$(document).keyup(function(e) {
		if (e.which != START_PLAY) { // Tasto S
			return;
		}
		if (Machine.inGame) {
			return;
		}
		Machine.stopDemo().then(function() {
			// spegne la musica
			Music.mute();
			// chiudo il lettore
			$.post('/close-tray');
			// Mostra il messaggio (Tira la leva!)		
			Machine.emit('startGame');
			Machine.inGame = true;
		});
	});
	
	$(document).keyup(function(e) {
		if (e.which != ROLL) {
			return;
		}
		if (! Machine.inGame) {
			return;
		}
		var winning = Math.random() > 0.4;  // una volta su due (todo?)
		Machine.roll(winning).then(function() {
			if (winning) {
				console.log('Il giocatore vince');
				Machine.emit('playerWin');
			} else {
				console.log('Il giocatore perde');
				Machine.emit('playerLoose');
				$.post('/open-tray');
				Machine.inGame = false;
				Music.unmute();
				// dopo qualche secondo torna il demo.
				window.setTimeout(3000, function() {
					Machine.startDemo();
				});
				
			}
		});
	});
});

</script>
</body>
</html>
