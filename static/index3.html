<html>
	<head>
	<title>Wedding Machine</title>
	<style>
	html, body { margin: 0; padding: 0; 
	background-color: #000;
	}
	#slotmachine {
		width: 640px; height: 480px;
		position: absolute;
		left: 50%;
		margin-left: -320px;
	}
	h1 { color: #fff; text-align: center; }
	
	</style>
</head>
<body>
<h1>Premi il pulsante per iniziare a giocare!</h1>
<audio id="idle-music" src="/idle-music.ogg" loop autoplay></audio>
<script src="/three.js"></script>
<script src="/tween.js"></script>
<script src="/jquery.js"></script>
<script src="/eventable.js"></script>
<script src="/rsvp.js"></script>
<script src="/machine.js"></script>
<script>

var Music = {
	audio: $('#idle-music')[0],
	adjustVolume: function(volume) {
		return new RSVP.Promise(function(resolve, reject) {
			var alfa = {volume: Music.audio.volume},
				omega = {volume: volume},
				tween = new TWEEN.Tween(alfa).to(omega, 750)
							.onUpdate(function() {
								Music.audio.volume = this.volume;
							})
							.onComplete(resolve)
							.start();
		});
	},
	mute: function() {
		return Music.adjustVolume(0);
	},
	unmute: function() {
		return Music.adjustVolume(1);
	}
}

$(function() {
	Machine.startDemo();
	$.post('/open-tray');
	var music = $('#idle-music')[0],
		START_PLAY = 83,  // Tasto S
		ROLL = 65;  // Tasto A  
	
	RSVP.on('error', function(reason) {
		console.assert(false, reason);
	});

	$(document).keyup(function(e) {
		if (e.which != START_PLAY) { // Tasto S
			return;
		}
		if (Machine.inGame) {
			return;
		}
		Machine.stopDemo().then(function() {
			// spegne la musica
			Music.mute();
			// chiudo il lettore
			$.post('/close-tray');
			// Mostra il messaggio (Tira la leva!)		
			console.log('Pronto per giocare');
			Machine.inGame = true;
		});
	});
	
	$(document).keyup(function(e) {
		if (e.which != ROLL) {
			return;
		}
		if (! Machine.inGame) {
			return;
		}
		var winning = Math.random() > 0.5;  // una volta su due (todo?)
		Machine.roll(winning).then(function() {
			if (winning) {
				console.log('Hai vinto! Tira ancora la leva per rilanciare');
			} else {
				console.log('Hai perso! Ritira i tuoi confetti');
				$.post('/open-tray');
				Machine.inGame = false;
				// dopo qualche secondo torna il demo.
				Machine.startDemo();
			}
		});
	});
});

</script>
</body>
</html>
